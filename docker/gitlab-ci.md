# Gitlab CI with docker.

Недавно пришлось настраивать собственную систему CI на базе Gitlab. Эта заметка о том что было сделано и зачем.

## Ограничения
GitLab Community Edition 8.3.2 - главная проблема. Возможность обновить отсутствует.
1 Машина - тестовая мощность на данный момент. На данный момент больше не нужно.

## Ну погнали
Главной целью была полная автоматизация процесса тестирования и разворачивания в тестовом окружении после `git push`.
Окей, давайте по шагам:

1. git push
1. gitlab build
1. gitlab test
1. gitlab deploy

## build + test
Начну с простого - сборки и тестирования. Интеграция с gitlab-ci начинается с добавления в проект файла `.gitlab-ci.yml`

```yml
stages:
  - build
  - test

build:
  stage: build
  script:
    - mvn -U -DskipTests clean package

test:
  stage: test
  script:
    - mvn clean test verify
    - cat target/site/jacoco/index.html | egrep -o 'Total.*?[0-9]{1,3}%' | egrep -o '[0-9]{1,3}%' | head -1   
```

Раздел `stages` описывет что последовательно будет делать в проектом gitlab. 
Сейчас у нас есть стадии `build` и `test`.
На стадии `test` в скриптах присутствует довольно страшная строчка с грепами. 
Она нужна, чтобы вытащить процент покрытия проекта тестами.
Кто-то может сказать, что gitlab позволяет делать `pages:` но не в моей версии, к сожалению. 
Так что выкручивался как мог.

Хорошо, сборка и тестрирование есть. Переходим к деплойменту.

## deploy
На стадии `deploy` я ожидаю получить два результата:
- загруженный артефакт в nexus
- запущенный докер контейнер с текущей версией приложения

Окей, давайте сначала разберемся с nexus'ом.

Для того, чтобы поддержать такой деплой нужно три вещи:
1. Чтобы gitlab знал о существовании вашего nexus'a
2. Добавить новый `stage` в `.gitlab-ci.yml`
3. Описать этот `stage`

```yaml
stages:
  ...
  - deploy
...
deploy-snapshot:
  stage: deploy
  script:
    - mvn -DskipTests deploy
  only:
    - master
```
Из конфига понятно, что деплоить я хочу только из ветки `master`. 
В этой фазе я уже могу пропустить тесты, которые прошли в предыдущей.

## docker
Осталось только научиться собирать образы совего приложения и деплоить их.
Из контекста понятно, что приложение собирается `maven`.
Код написан на java 8, значит нам еще понадобится подходящий `jre`.
Приложение должно быть доступно на тестовой машине - придется прокинуть какие-то порты.

Начнем с описания Dockerfile
```
FROM openjdk:8-jre-alpine

RUN mkdir -p /src/app
WORKDIR /src/app

COPY /path/to/target/app.jar /src/app/my-app.jar
EXPOSE <ports>

CMD ["java", "-jar", "my-app.jar"]
```

Для выполнения всех стадий CI gitlab использует runner'ы. 
Значит runner должен знать что такое jre, maven и docker.
Давайте создадим такой.
 




